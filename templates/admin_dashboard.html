{% extends "base.html" %}

{% block title %}Tableau de bord Administrateur - Planify{% endblock %}

{% block page_title %}Tableau de bord Administrateur{% endblock %}

{% block content %}
{% set show_stats_cards = parametres.show_stats_cards if parametres and parametres.show_stats_cards is not none else True %}
{% set show_quick_actions = parametres.show_quick_actions if parametres and parametres.show_quick_actions is not none else True %}
{% set show_ai_insights = parametres.show_ai_insights if parametres and parametres.show_ai_insights is not none else True %}
{% set show_recent_missions = parametres.show_recent_missions if parametres and parametres.show_recent_missions is not none else True %}
<div class="container">
    <!-- Message de bienvenue -->
    <div class="welcome-card">
        <div class="welcome-content">
            <h1><i class="fas fa-crown"></i> Bienvenue, {{ current_user.prenom }} {{ current_user.nom }}</h1>
            <p>Interface d'administration complète</p>
            <div class="groq-status">
                <span class="status-pill {{ 'status-ok' if groq_status.active else 'status-warn' }}">
                    Groq IA : {{ groq_status.message }}
                </span>
                {% if groq_status.error %}
                <div class="text-xs text-red-600 mt-1">{{ groq_status.error }}</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Statistiques principales -->
    {% if show_stats_cards %}
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_prestations }}</h3>
                <p>Total Missions</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_users }}</h3>
                <p>Utilisateurs</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tools"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_materiels }}</h3>
                <p>Équipements</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_locals }}</h3>
                <p>Sites</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stat-content">
                <h3>{{ stats.total_devis or 0 }}</h3>
                <p>Devis</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions rapides -->
    {% if show_quick_actions %}
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-bolt"></i> Actions Rapides</h2>
        </div>
        <div class="card-body">
            <div class="action-grid">
                <a href="{{ url_for('register') }}" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    <span>Nouvel Utilisateur</span>
                </a>
                
                <a href="{{ url_for('nouvelle_prestation') }}" class="action-btn">
                    <i class="fas fa-calendar-plus"></i>
                    <span>Nouvelle Mission</span>
                </a>
                
                <a href="{{ url_for('nouveau_materiel') }}" class="action-btn">
                    <i class="fas fa-plus"></i>
                    <span>Nouveau Équipement</span>
                </a>
                
                <a href="{{ url_for('users') }}" class="action-btn">
                    <i class="fas fa-users-cog"></i>
                    <span>Gérer Utilisateurs</span>
                </a>
                
                <a href="{{ url_for('facturation') }}" class="action-btn">
                    <i class="fas fa-file-invoice"></i>
                    <span>Gérer Devis</span>
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Insights IA -->
    {% if show_ai_insights %}
    <div class="card" id="ai-insights">
        <div class="card-header ai-insights-header">
            <div>
                <h2><i class="fas fa-robot"></i> Insights IA</h2>
                <p class="ai-insights-subtitle">Synthèse automatique des tendances et du planning à venir.</p>
            </div>
            <div class="ai-insights-badges">
                <span class="ai-pill ai-pill-primary">Prévisions</span>
                <span class="ai-pill ai-pill-secondary">Optimisation</span>
            </div>
        </div>
        <div class="card-body">
            <div class="ai-insights-grid">
                <div class="ai-insight-card">
                    <div class="ai-insight-head">
                        <div class="ai-insight-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div>
                            <h4>Prévisions CA</h4>
                            <span class="ai-insight-meta">3 prochains mois</span>
                        </div>
                    </div>
                    <div id="ai-forecast-container" class="ai-insight-content">
                        <div class="ai-skeleton">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                <div class="ai-insight-card">
                    <div class="ai-insight-head">
                        <div class="ai-insight-icon">
                            <i class="fas fa-sitemap"></i>
                        </div>
                        <div>
                            <h4>Optimisation du planning</h4>
                            <span class="ai-insight-meta">30 prochains jours • Suggestions non automatiques</span>
                        </div>
                    </div>
                    <div class="ai-insight-note">
                        L’IA repère les regroupements possibles, les chevauchements et les créneaux à optimiser.
                    </div>
                    <div id="ai-optimize-container" class="ai-insight-content">
                        <div class="ai-skeleton">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Prestations récentes -->
    {% if show_recent_missions %}
    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-clock"></i> Missions Récentes</h2>
        </div>
        <div class="card-body">
            {% if prestations_recentes %}
                <div style="display: grid; gap: 12px;">
                    {% for prestation in prestations_recentes %}
                    <div style="background: white; border: 1px solid rgba(0, 0, 0, 0.06); border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; transition: all 0.2s ease;">
                        <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #34C759 0%, #30D158 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-calendar-check" style="font-size: 16px; color: white;"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 15px; font-weight: 600; color: #1d1d1f;">{{ prestation.client }}</div>
                            <div style="font-size: 12px; color: #86868b;"><i class="fas fa-map-marker-alt"></i> {{ prestation.lieu }}</div>
                        </div>
                        <div style="font-size: 13px; font-weight: 600; color: #515154;">{{ prestation.date_debut.strftime('%d/%m/%Y') }}</div>
                        <span class="status-badge status-{{ prestation.statut }}" style="padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">{{ prestation.statut|title }}</span>
                        <a href="{{ url_for('detail_prestation', prestation_id=prestation.id) }}" 
                           style="padding: 6px 12px; border-radius: 6px; background: #0071E3; color: white; text-decoration: none; font-size: 12px; font-weight: 500; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s ease; border: none; cursor: pointer;">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <h3>Aucune mission</h3>
                    <p>Commencez par créer une mission</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Statistiques détaillées -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-chart-pie"></i> Missions</h2>
                </div>
                <div class="card-body">
                    <div class="stat-item">
                        <span class="stat-label">Planifiées</span>
                        <span class="stat-value">{{ stats.prestations_planifiees }}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Confirmées</span>
                        <span class="stat-value">{{ stats.prestations_confirmees }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-tools"></i> Équipement</h2>
                </div>
                <div class="card-body">
                    <div class="stat-item">
                        <span class="stat-label">Disponibles</span>
                        <span class="stat-value">{{ stats.materiels_disponibles }}</span>
                    </div>
                    <!-- Statut 'reserve' supprimé - matériel soit disponible soit maintenance -->
                    <div class="stat-item">
                        <span class="stat-label">Maintenance</span>
                        <span class="stat-value">{{ stats.materiels_maintenance }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.welcome-card {
    background: linear-gradient(135deg, #0071e3 0%, #005bb5 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
}

.welcome-content h1 {
    margin: 0 0 10px 0;
    font-size: 2rem;
}

.welcome-content p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
}
.groq-status {
    margin-top: 10px;
}
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.2px;
}
.status-ok {
    background: rgba(52, 199, 89, 0.18);
    color: #0a8a3a;
}
.status-warn {
    background: rgba(255, 159, 10, 0.18);
    color: #b26a00;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.3s;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    background: #0071e3;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

.stat-content h3 {
    margin: 0;
    font-size: 2rem;
    color: #333;
}

.stat-content p {
    margin: 5px 0 0 0;
    color: #666;
    font-weight: 500;
}

.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 10px;
    text-decoration: none;
    color: #333;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.action-btn:hover {
    background: #0071e3;
    color: white;
    transform: translateY(-3px);
    border-color: #667eea;
}

.action-btn i {
    font-size: 2rem;
    margin-bottom: 10px;
}

.action-btn span {
    font-weight: 600;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #eee;
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    font-weight: 500;
    color: #666;
}

.stat-value {
    font-weight: 600;
    font-size: 1.2rem;
    color: #333;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-planifiee {
    background: #fff3cd;
    color: #856404;
}

.status-confirmee {
    background: #d4edda;
    color: #155724;
}

.status-terminee {
    background: #d1ecf1;
    color: #0c5460;
}

.ai-insights-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
}

.ai-insights-subtitle {
    margin: 6px 0 0 0;
    color: #6b7280;
    font-size: 0.92rem;
}

.ai-insights-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.ai-pill {
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.2px;
    border: 1px solid transparent;
}

.ai-pill-primary {
    background: rgba(0, 113, 227, 0.12);
    color: #0b63c6;
    border-color: rgba(0, 113, 227, 0.2);
}

.ai-pill-secondary {
    background: rgba(52, 199, 89, 0.12);
    color: #1f9d57;
    border-color: rgba(52, 199, 89, 0.2);
}

.ai-insights-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 18px;
}

.ai-insight-card {
    border: 1px solid #edf0f4;
    border-radius: 16px;
    padding: 18px;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.96) 0%, #f7f9fc 100%);
    box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
}

.ai-insight-head {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.ai-insight-head h4 {
    margin: 0;
    font-size: 1rem;
    color: #111827;
}

.ai-insight-meta {
    display: inline-flex;
    margin-top: 4px;
    font-size: 12px;
    color: #6b7280;
}

.ai-insight-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: rgba(0, 113, 227, 0.15);
    color: #0071e3;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.ai-insight-card:nth-child(2) .ai-insight-icon {
    background: rgba(52, 199, 89, 0.18);
    color: #1f9d57;
}

.ai-insight-content {
    color: #4b5563;
    font-size: 0.95rem;
}

.ai-insight-note {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 10px;
}

.ai-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 10px;
}

.ai-list li {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: 12px;
    background: white;
    border: 1px solid #eef1f5;
}

.ai-list-compact li {
    align-items: flex-start;
}

.ai-tag {
    margin-left: auto;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 8px;
    border-radius: 999px;
    background: #eef2ff;
    color: #4338ca;
    flex-shrink: 0;
}

.ai-tag-warning {
    background: rgba(239, 68, 68, 0.12);
    color: #b91c1c;
}

.ai-tag-success {
    background: rgba(34, 197, 94, 0.12);
    color: #15803d;
}

.ai-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #0071e3;
    flex-shrink: 0;
    margin-top: 6px;
}

.ai-dot-secondary {
    background: #1f9d57;
}

.ai-text {
    flex: 1;
    font-weight: 500;
    color: #111827;
}

.ai-metric {
    font-weight: 700;
    color: #0b63c6;
}

.ai-empty {
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    border: 1px dashed #e2e8f0;
    color: #6b7280;
    font-size: 0.9rem;
}

.ai-error {
    padding: 12px;
    background: #fff5f5;
    border-radius: 10px;
    border: 1px solid rgba(239, 68, 68, 0.2);
    color: #b91c1c;
    font-size: 0.9rem;
}

.ai-skeleton {
    display: grid;
    gap: 8px;
}

.ai-skeleton span {
    display: block;
    height: 10px;
    border-radius: 999px;
    background: linear-gradient(90deg, #eef2f7 0%, #f8fafc 50%, #eef2f7 100%);
    background-size: 200% 100%;
    animation: shimmer 1.6s infinite;
}

.ai-skeleton span:nth-child(2) {
    width: 85%;
}

.ai-skeleton span:nth-child(3) {
    width: 70%;
}

@keyframes shimmer {
    0% { background-position: 0% 0; }
    100% { background-position: 200% 0; }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }

    .ai-insights-header {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
}

function escapeHtml(value) {
    const div = document.createElement('div');
    div.textContent = value == null ? '' : String(value);
    return div.innerHTML;
}

function classifySuggestion(message) {
    const text = (message || '').toLowerCase();
    if (text.includes('conflit') || text.includes('chevauch') || text.includes('double')) {
        return { label: 'Conflit', cls: 'ai-tag-warning' };
    }
    if (text.includes('regrouper') || text.includes('regroup')) {
        return { label: 'Regroupement', cls: 'ai-tag-success' };
    }
    if (text.includes('disponib') || text.includes('créneau')) {
        return { label: 'Disponibilité', cls: '' };
    }
    return { label: 'Suggestion', cls: '' };
}

async function loadAiInsights() {
    const forecastContainer = document.getElementById('ai-forecast-container');
    const optimizeContainer = document.getElementById('ai-optimize-container');
    if (!forecastContainer || !optimizeContainer) {
        return;
    }

    try {
        const forecastsResp = await fetch('/api/ai/forecast-revenue?mois=3');
        const forecastsData = await forecastsResp.json();
        if (forecastsData.success && forecastsData.forecasts && forecastsData.forecasts.length) {
            const items = forecastsData.forecasts.map(item =>
                `<li>
                    <span class="ai-dot"></span>
                    <span class="ai-text">${escapeHtml(item.mois)}</span>
                    <span class="ai-metric">${escapeHtml(item.prevision)}€</span>
                </li>`
            ).join('');
            forecastContainer.innerHTML = `<ul class="ai-list">${items}</ul>`;
        } else {
            forecastContainer.innerHTML = '<div class="ai-empty">Pas assez de données pour prévoir.</div>';
        }
    } catch (error) {
        forecastContainer.innerHTML = '<div class="ai-error">Erreur de chargement des prévisions.</div>';
    }

    try {
        const headers = { 'Content-Type': 'application/json' };
        const csrfToken = getCsrfToken();
        if (csrfToken) headers['X-CSRF-Token'] = csrfToken;
        const today = new Date();
        const dateDebut = today.toISOString().split('T')[0];
        const future = new Date();
        future.setDate(today.getDate() + 30);
        const dateFin = future.toISOString().split('T')[0];
        const optimizeResp = await fetch('/api/ai/optimize-schedule', {
            method: 'POST',
            headers,
            body: JSON.stringify({ date_debut: dateDebut, date_fin: dateFin })
        });
        const optimizeData = await optimizeResp.json();
        if (optimizeData.success && optimizeData.suggestions && optimizeData.suggestions.length) {
            const items = optimizeData.suggestions.map(item => {
                const message = item.message || 'Suggestion IA';
                const tag = classifySuggestion(message);
                return `<li>
                    <span class="ai-dot ai-dot-secondary"></span>
                    <span class="ai-text">${escapeHtml(message)}</span>
                    <span class="ai-tag ${tag.cls}">${escapeHtml(tag.label)}</span>
                </li>`;
            }).join('');
            optimizeContainer.innerHTML = `<ul class="ai-list ai-list-compact">${items}</ul>`;
        } else {
            optimizeContainer.innerHTML = '<div class="ai-empty">Aucune suggestion pour la période.</div>';
        }
    } catch (error) {
        optimizeContainer.innerHTML = '<div class="ai-error">Erreur de chargement des suggestions.</div>';
    }
}

document.addEventListener('DOMContentLoaded', loadAiInsights);
</script>
{% endblock %}
