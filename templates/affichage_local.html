{% extends "public_base.html" %}
{% set body_class = "public-shell--wide local-display" %}
{% block title %}{{ local.nom }} - Affichage Site{% endblock %}

{% block content %}
<div class="display-container">
    <div class="card public-hero header">
        <h1><i class="fas fa-building"></i> {{ local.nom }}</h1>
        <p>{{ local.adresse }}</p>
    </div>

    <div class="status-grid">
        <div class="status-card disponible">
            <div class="status-header">
                <div class="status-icon disponible">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2 class="status-title">Disponible</h2>
            </div>
            <div class="status-count" id="available-count">
                {{ materiels|selectattr('statut_affichage', 'equalto', 'disponible')|list|length }}
            </div>
            <ul class="materiel-list" id="available-list">
                {% for materiel in materiels %}
                {% if materiel.statut_affichage == 'disponible' %}
                <li class="materiel-item disponible">
                    <div>
                        <div class="materiel-name">{{ materiel.nom }}</div>
                        <div class="materiel-meta">{{ materiel.categorie }}</div>
                    </div>
                    <span class="materiel-quantity">{{ materiel.quantite }}</span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="status-card occupe">
            <div class="status-header">
                <div class="status-icon occupe">
                    <i class="fas fa-clock"></i>
                </div>
                <h2 class="status-title">En mission</h2>
            </div>
            <div class="status-count" id="in-prestation-count">
                {{ materiels|selectattr('statut_affichage', 'equalto', 'occupe')|list|length }}
            </div>
            <ul class="materiel-list" id="in-prestation-list">
                {% for materiel in materiels %}
                {% if materiel.statut_affichage == 'occupe' %}
                <li class="materiel-item occupe">
                    <div>
                        <div class="materiel-name">{{ materiel.nom }}</div>
                        <div class="materiel-meta">{{ materiel.categorie }}</div>
                        {% if materiel.materiel_assignations and materiel.materiel_assignations[0].prestation %}
                        <div class="prestation-info">Assigné à: {{ materiel.materiel_assignations[0].prestation.client }}</div>
                        {% endif %}
                    </div>
                    <span class="materiel-quantity">{{ materiel.quantite }}</span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="status-card partiel">
            <div class="status-header">
                <div class="status-icon partiel">
                    <i class="fas fa-adjust"></i>
                </div>
                <h2 class="status-title">Partiel</h2>
            </div>
            <div class="status-count" id="partial-count">
                {{ materiels|selectattr('statut_affichage', 'equalto', 'partiel')|list|length }}
            </div>
            <ul class="materiel-list" id="partial-list">
                {% for materiel in materiels %}
                {% if materiel.statut_affichage == 'partiel' %}
                <li class="materiel-item partiel">
                    <div>
                        <div class="materiel-name">{{ materiel.nom }}</div>
                        <div class="materiel-meta">{{ materiel.categorie }}</div>
                        {% if materiel.materiel_assignations and materiel.materiel_assignations[0].prestation %}
                        <div class="prestation-info">Assigné à: {{ materiel.materiel_assignations[0].prestation.client }}</div>
                        {% endif %}
                    </div>
                    <span class="materiel-quantity">{{ materiel.quantite }}</span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>

        <div class="status-card maintenance">
            <div class="status-header">
                <div class="status-icon maintenance">
                    <i class="fas fa-wrench"></i>
                </div>
                <h2 class="status-title">Maintenance</h2>
            </div>
            <div class="status-count" id="maintenance-count">
                {{ materiels|selectattr('statut_affichage', 'equalto', 'maintenance')|list|length }}
            </div>
            <ul class="materiel-list" id="maintenance-list">
                {% for materiel in materiels %}
                {% if materiel.statut_affichage == 'maintenance' %}
                <li class="materiel-item maintenance">
                    <div>
                        <div class="materiel-name">{{ materiel.nom }}</div>
                        <div class="materiel-meta">{{ materiel.categorie }}</div>
                    </div>
                    <span class="materiel-quantity">{{ materiel.quantite }}</span>
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>

    <div class="public-note refresh-info">
        <i class="fas fa-sync-alt"></i>
        Mise à jour automatique toutes les 30 secondes
    </div>
</div>

<div class="last-update" id="last-update">
    Dernière mise à jour: <span id="update-time">Maintenant</span>
</div>
{% endblock %}

{% block scripts %}
<script>
    function refreshData() {
        fetch(`/api/materiels/local/{{ local.id }}`)
            .then(response => response.json())
            .then(data => {
                updateDisplay(data);
                document.getElementById('update-time').textContent = new Date().toLocaleTimeString();
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
            });
    }

    function updateDisplay(materiels) {
        const counts = {
            disponible: materiels.filter(m => m.statut_affichage === 'disponible').length,
            en_prestation: materiels.filter(m => m.statut_affichage === 'occupe').length,
            partiel: materiels.filter(m => m.statut_affichage === 'partiel').length,
            maintenance: materiels.filter(m => m.statut_affichage === 'maintenance').length
        };

        document.getElementById('available-count').textContent = counts.disponible;
        document.getElementById('in-prestation-count').textContent = counts.en_prestation;
        document.getElementById('partial-count').textContent = counts.partiel;
        document.getElementById('maintenance-count').textContent = counts.maintenance;

        updateMaterielList('available-list', materiels.filter(m => m.statut_affichage === 'disponible'));
        updateMaterielList('in-prestation-list', materiels.filter(m => m.statut_affichage === 'occupe'));
        updateMaterielList('partial-list', materiels.filter(m => m.statut_affichage === 'partiel'));
        updateMaterielList('maintenance-list', materiels.filter(m => m.statut_affichage === 'maintenance'));
    }

    function updateMaterielList(listId, materiels) {
        const list = document.getElementById(listId);
        list.innerHTML = materiels.map(materiel => `
            <li class="materiel-item ${materiel.statut_affichage}">
                <div>
                    <div class="materiel-name">${materiel.nom}</div>
                    <div class="materiel-meta">${materiel.categorie || 'Non défini'}</div>
                    ${materiel.prestation ? `<div class="prestation-info">Assigné à: ${materiel.prestation}</div>` : ''}
                </div>
                <span class="materiel-quantity">${materiel.quantite}</span>
            </li>
        `).join('');
    }

    setInterval(refreshData, 30000);

    document.addEventListener('DOMContentLoaded', function() {
        refreshData();
    });
</script>
{% endblock %}
