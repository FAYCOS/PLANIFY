{% extends "base.html" %}

{% block title %}Missions - Planify{% endblock %}
{% block page_title %}Gestion des missions{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Actions -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex gap-4">
            {% if current_user and current_user.role in ['admin', 'manager'] %}
            <a href="{{ url_for('nouvelle_prestation') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Nouvelle mission
            </a>
            {% endif %}
            <a href="{{ url_for('calendrier') }}" class="btn btn-secondary">
                <i class="fas fa-calendar"></i>
                Vue calendrier
            </a>
        </div>
        <form class="flex gap-2 flex-wrap items-center" method="GET" action="{{ url_for('prestations') }}">
            <select class="form-control" name="statut" style="width: auto;" onchange="this.form.submit()">
                <option value="" {% if not filters or not filters.statut %}selected{% endif %}>Tous les statuts</option>
                <option value="planifiee" {% if filters and filters.statut == 'planifiee' %}selected{% endif %}>Planifiée</option>
                <option value="confirmee" {% if filters and filters.statut == 'confirmee' %}selected{% endif %}>Confirmée</option>
                <option value="terminee" {% if filters and filters.statut == 'terminee' %}selected{% endif %}>Terminée</option>
                <option value="annulee" {% if filters and filters.statut == 'annulee' %}selected{% endif %}>Annulée</option>
            </select>
            <input type="date" name="date_from" class="form-control" value="{{ filters.date_from if filters else '' }}">
            <input type="date" name="date_to" class="form-control" value="{{ filters.date_to if filters else '' }}">
            <button type="submit" class="btn btn-secondary">Filtrer</button>
        </form>
    </div>

    <!-- Liste des prestations en cards -->
    <div style="display: grid; gap: 16px;">
        {% if prestations.items|length == 0 %}
        <div class="card">
            <div class="card-body text-center">
                <h3 class="text-lg font-semibold mb-2">Aucune mission trouvée</h3>
                {% if current_user and current_user.role in ['dj', 'technicien'] %}
                <p class="text-gray-600">Vous n'avez aucune mission assignée pour cette période.</p>
                {% else %}
                <p class="text-gray-600">Créez une nouvelle mission pour commencer.</p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% for prestation in prestations.items %}
        <div class="prestation-row" data-statut="{{ prestation.statut }}" style="background: white; border: 1px solid rgba(0, 0, 0, 0.06); border-radius: 16px; padding: 24px; display: flex; align-items: center; gap: 24px; transition: all 0.2s ease; flex-wrap: wrap;">
            
            <!-- Icône prestation -->
            <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--green) 0%, #3A976C 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <i class="fas fa-calendar-check" style="font-size: 24px; color: white;"></i>
            </div>
            
            <!-- Infos prestation -->
            <div style="flex: 1; min-width: 0;">
                <div style="font-size: 17px; font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">
                    {{ prestation.client }}
                </div>
                <div style="font-size: 13px; color: var(--text-gray); margin-bottom: 8px;">
                    <i class="fas fa-map-marker-alt"></i> {{ prestation.lieu }}
                    {% if prestation.notes %}
                    • {{ prestation.notes[:50] }}{% if prestation.notes|length > 50 %}...{% endif %}
                    {% endif %}
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-user" style="color: var(--text-gray); font-size: 12px;"></i>
                        <span style="font-size: 13px; color: var(--text-dark);">{{ prestation.dj.nom if prestation.dj else 'Non assigné' }}</span>
                    </div>
                    {% if prestation.technicien %}
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-tools" style="color: var(--text-gray); font-size: 12px;"></i>
                        <span style="font-size: 13px; color: var(--text-dark);">{{ prestation.technicien.nom }} {{ prestation.technicien.prenom }}</span>
                    </div>
                    {% endif %}
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-calendar" style="color: var(--text-gray); font-size: 12px;"></i>
                        <span style="font-size: 13px; color: var(--text-dark);">{{ prestation.date_debut.strftime('%d/%m/%Y') }} → {{ prestation.date_fin.strftime('%d/%m/%Y') }}</span>
                    </div>
                    {% if prestation.materiel_assignations %}
                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                        <i class="fas fa-cogs" style="color: var(--text-gray); font-size: 12px;"></i>
                        {% for assignation in prestation.materiel_assignations[:3] %}
                        {% set materiel = assignation.materiel %}
                        <span style="display: inline-block; background: var(--light-gray); color: var(--text-dark); padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                            {{ materiel.nom }} x{{ assignation.quantite }}
                        </span>
                        {% endfor %}
                        {% if prestation.materiel_assignations|length > 3 %}
                        <span style="font-size: 11px; color: var(--text-gray);">+{{ prestation.materiel_assignations|length - 3 }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mini-carte -->
            <div class="prestation-mini-map" data-lat="{{ prestation.lieu_lat }}" data-lng="{{ prestation.lieu_lng }}">
                {% if not prestation.lieu_lat or not prestation.lieu_lng %}
                <div class="mini-map-placeholder">Adresse non géocodée</div>
                {% endif %}
                <span class="mini-map-attribution">© OpenStreetMap</span>
            </div>
            
            <!-- Statut -->
            <div style="flex-shrink: 0;">
                <span class="status-badge status-{{ prestation.statut }}" style="padding: 8px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; white-space: nowrap;">
                    {{ prestation.statut|title }}
                </span>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 8px; flex-shrink: 0;">
                <a href="{{ url_for('detail_prestation', prestation_id=prestation.id) }}" 
                   style="padding: 10px 16px; border-radius: 10px; background: var(--light-gray); color: var(--text-dark); text-decoration: none; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s ease; border: none; cursor: pointer;"
                   title="Voir"
                   onmouseover="this.style.background='var(--medium-gray)'"
                   onmouseout="this.style.background='var(--light-gray)'">
                    <i class="fas fa-eye"></i>
                </a>
                {% if current_user and current_user.role in ['admin', 'manager'] %}
                <a href="{{ url_for('modifier_prestation', prestation_id=prestation.id) }}" 
                   style="padding: 10px 20px; border-radius: 10px; background: var(--blue); color: white; text-decoration: none; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s ease; border: none; cursor: pointer;"
                   onmouseover="this.style.background='var(--blue-hover)'"
                   onmouseout="this.style.background='var(--blue)'">
                    <i class="fas fa-edit"></i>
                    Modifier
                </a>
                {% endif %}
                {% if current_user and current_user.role in ['admin', 'manager'] %}
                <form method="POST" action="{{ url_for('supprimer_prestation', prestation_id=prestation.id) }}" 
                      style="display: inline; margin: 0;" 
                      onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette prestation ?')">
                    <button type="submit" 
                            style="padding: 10px 16px; border-radius: 10px; background: var(--red); color: white; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;"
                            title="Supprimer">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
                {% endif %}
            </div>
            
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if prestations.pages > 1 %}
    <div class="flex justify-center items-center gap-2 mt-6">
        {% if prestations.has_prev %}
        <a href="{{ url_for('prestations', page=prestations.prev_num, statut=filters.statut if filters else None, date_from=filters.date_from if filters else None, date_to=filters.date_to if filters else None) }}" class="btn btn-secondary">
            <i class="fas fa-chevron-left"></i>
            Précédent
        </a>
        {% endif %}
        
        <span class="text-sm text-gray-600">
            Page {{ prestations.page }} sur {{ prestations.pages }}
        </span>
        
        {% if prestations.has_next %}
        <a href="{{ url_for('prestations', page=prestations.next_num, statut=filters.statut if filters else None, date_from=filters.date_from if filters else None, date_to=filters.date_to if filters else None) }}" class="btn btn-secondary">
            Suivant
            <i class="fas fa-chevron-right"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
    .prestation-mini-map {
        width: 160px;
        height: 110px;
        border-radius: 12px;
        border: 1px solid rgba(15, 23, 42, 0.12);
        background: #f8fafc;
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
    }
    .mini-map-placeholder {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        color: #6b7280;
        text-align: center;
        padding: 6px;
    }
    .mini-map-attribution {
        position: absolute;
        bottom: 4px;
        right: 6px;
        font-size: 9px;
        color: rgba(15, 23, 42, 0.5);
        background: rgba(255, 255, 255, 0.7);
        padding: 1px 4px;
        border-radius: 999px;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.prestation-mini-map').forEach((el) => {
        const lat = parseFloat(el.dataset.lat);
        const lng = parseFloat(el.dataset.lng);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
            return;
        }

        el.innerHTML = '<span class="mini-map-attribution">© OpenStreetMap</span>';

        const map = L.map(el, {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false,
            doubleClickZoom: false,
            boxZoom: false,
            keyboard: false,
            tap: false
        }).setView([lat, lng], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);
        L.marker([lat, lng], { interactive: false }).addTo(map);
    });
});
</script>
{% endblock %}
